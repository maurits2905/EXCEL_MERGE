<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Excel Merger ‚Äì Tabs from multiple files</title>

    <!-- SheetJS (community) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --bg1: #0b1220;
            --bg2: #071728;
            --card: rgba(255, 255, 255, .08);
            --card2: rgba(255, 255, 255, .06);
            --stroke: rgba(255, 255, 255, .14);
            --text: rgba(255, 255, 255, .92);
            --muted: rgba(255, 255, 255, .65);

            --good: #43f08a;
            --warn: #ffd166;
            --bad: #ff5c7a;
            --btn: #dbeafe;
            --btnText: #0b1220;
            --btn2: rgba(255, 255, 255, .10);
            --btn2Text: rgba(255, 255, 255, .92);
            --btn2Stroke: rgba(255, 255, 255, .16);

            --barBg: rgba(255, 255, 255, .10);
            --barFill: rgba(219, 234, 254, .90);
            --barFill2: rgba(67, 240, 138, .80);
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            color: var(--text);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background:
                radial-gradient(1200px 700px at 20% 10%, rgba(67, 240, 138, .14), transparent 60%),
                radial-gradient(900px 600px at 85% 20%, rgba(59, 130, 246, .16), transparent 55%),
                linear-gradient(180deg, var(--bg1), var(--bg2));
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 32px 16px;
        }

        .wrap {
            width: min(980px, 100%);
            display: grid;
            grid-template-columns: 1.25fr .75fr;
            gap: 16px;
        }

        @media (max-width: 880px) {
            .wrap {
                grid-template-columns: 1fr;
            }
        }

        .card {
            border: 1px solid var(--stroke);
            background: linear-gradient(180deg, var(--card), var(--card2));
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, .25);
            backdrop-filter: blur(10px);
        }

        .title {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .badge {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: grid;
            place-items: center;
            background: rgba(67, 240, 138, .18);
            border: 1px solid rgba(67, 240, 138, .35);
            font-weight: 800;
        }

        h1 {
            margin: 0;
            font-size: 18px;
        }

        .sub {
            margin: 6px 0 0;
            color: var(--muted);
            line-height: 1.45;
            font-size: 13px;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 14px;
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .row input#outputName{
            flex: 1 1 260px;
            min-width: 220px;
            padding: 12px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,.14);
            background: rgba(0,0,0,.18);
            color: rgba(255,255,255,.92);
            outline: none;
        }

        .row input#outputName::placeholder{
            color: rgba(255,255,255,.55);
        }

        .row input#outputName:focus{
            border-color: rgba(219,234,254,.45);
            box-shadow: 0 0 0 3px rgba(219,234,254,.10);
        }


        .dropzone {
            width: 100%;
            padding: 14px;
            border-radius: 14px;
            border: 1px dashed rgba(255, 255, 255, .22);
            background: rgba(255, 255, 255, .04);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .dropzone.dragover {
            border-color: rgba(219, 234, 254, .65);
            background: rgba(219, 234, 254, .08);
            box-shadow: inset 0 0 0 1px rgba(219, 234, 254, .15);
        }

        .dz-top {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .dz-title {
            font-size: 12px;
            font-weight: 800;
            color: rgba(255, 255, 255, .85);
        }

        .dz-sub {
            font-size: 12px;
            color: var(--muted);
        }

        .btn {
            appearance: none;
            border: 0;
            border-radius: 12px;
            padding: 12px 14px;
            font-weight: 800;
            background: var(--btn);
            color: var(--btnText);
            cursor: pointer;
            user-select: none;
            text-decoration: none;
            transition: transform .06s ease, opacity .2s ease, filter .2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn:hover {
            filter: brightness(1.03);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn:disabled {
            opacity: .45;
            cursor: not-allowed;
        }

        .btn.secondary {
            background: var(--btn2);
            color: var(--btn2Text);
            border: 1px solid var(--btn2Stroke);
            font-weight: 700;
        }

        .btn.small {
            padding: 8px 10px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 12px;
        }

        .btn.danger {
            background: rgba(255, 92, 122, .14);
            border: 1px solid rgba(255, 92, 122, .30);
            color: rgba(255, 255, 255, .92);
        }

        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .filelist {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .fileitem {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .10);
            background: rgba(255, 255, 255, .04);
        }

        .fileitem[draggable="true"] {
            cursor: grab;
        }

        .fileitem.dragging {
            opacity: .6;
            cursor: grabbing;
        }

        .left {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            min-width: 0;
            flex: 1;
        }

        .handle {
            width: 28px;
            height: 28px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, .14);
            background: rgba(0, 0, 0, .18);
            display: grid;
            place-items: center;
            color: rgba(255, 255, 255, .75);
            font-size: 14px;
            user-select: none;
            flex: 0 0 auto;
        }

        .filemeta {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0;
            flex: 1;
        }

        .filename {
            font-size: 13px;
            font-weight: 800;
            color: rgba(255, 255, 255, .90);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 520px;
        }

        .filesub {
            font-size: 12px;
            color: var(--muted);
        }

        .opt {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .10);
            background: rgba(255, 255, 255, .04);
        }

        .opt input {
            transform: translateY(1px);
        }

        label {
            font-size: 12px;
            color: var(--muted);
        }

        .progressWrap {
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(0, 0, 0, .18);
            border-radius: 14px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 12px;
        }

        .pRow {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            align-items: baseline;
            flex-wrap: wrap;
        }

        .pTitle {
            font-size: 12px;
            font-weight: 800;
            color: rgba(255, 255, 255, .88);
        }

        .pMeta {
            font-size: 12px;
            color: var(--muted);
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
        }

        .bar {
            height: 10px;
            border-radius: 999px;
            background: var(--barBg);
            border: 1px solid rgba(255, 255, 255, .10);
            overflow: hidden;
        }

        .fill {
            height: 100%;
            width: 0%;
            background: var(--barFill);
            border-radius: 999px;
            transition: width .12s ease;
        }

        .fill.alt {
            background: var(--barFill2);
        }

        .log {
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            font-size: 12px;
            color: rgba(255, 255, 255, .85);
            background: rgba(0, 0, 0, .22);
            border: 1px solid rgba(255, 255, 255, .12);
            border-radius: 12px;
            padding: 12px;
            min-height: 190px;
            white-space: pre-wrap;
            overflow: auto;
            margin-top: 10px;
        }

        .side h2 {
            margin: 0 0 10px;
            font-size: 14px;
            color: rgba(255, 255, 255, .88);
        }

        .side ul {
            margin: 0;
            padding-left: 18px;
            color: var(--muted);
            line-height: 1.5;
            font-size: 13px;
        }

        .ok {
            color: var(--good);
        }

        .warn {
            color: var(--warn);
        }

        .bad {
            color: var(--bad);
        }
    </style>
</head>

<body>
    <div class="wrap">
        <section class="card">
            <div class="title">
                <div class="badge">X</div>
                <div>
                    <h1>Excel Merger</h1>
                    <p class="sub">Merge multiple Excel files into a single workbook.</p>
                </div>
            </div>

            <div class="controls">
                <input id="filePicker" class="visually-hidden" type="file" accept=".xlsx,.xlsm" multiple />

                <div id="dropzone" class="dropzone">
                    <div class="dz-top">
                        <div>
                            <div class="dz-title">Drop Excel files here</div>
                            <div class="dz-sub">or click ‚ÄúAdd files‚Äù.
                            </div>
                        </div>

                        <label for="filePicker" class="btn secondary small" role="button" tabindex="0">Add files</label>
                    </div>

                    <ul id="fileList" class="filelist"></ul>
                </div>

                <div class="opt">
                    <input id="prefixNames" type="checkbox" checked />
                    <label for="prefixNames">Prefix sheet names with file name (recommended)</label>
                </div>
                
                <div class="opt">
                    <input id="keepFormulas" type="checkbox" checked />
                    <label for="keepFormulas">Keep formulas (if present)</label>
                </div>
                
                <div class="row">
                    <input id="outputName" type="text" placeholder="Output file name" />
                    <button id="mergeBtn" class="btn" disabled type="button">Create merged Excel</button>
                    <button id="resetBtn" class="btn secondary" type="button">Reset</button>
                </div>

            </div>
        </section>

        <aside class="card side">
            <h2>Limitations</h2>
            <ul>
                <li><span class="ok">‚úÖ</span> Sheets and cell data (values and most formulas)</li>
                <li><span class="ok">‚úÖ</span> Merged cells and often column widths</li>
                <li><span class="warn">‚ö†Ô∏è</span> Advanced formatting and themes may change</li>
                <li><span class="bad">‚úñ</span> PivotTables, charts, images, Power Query, and macros are not reliably preserved</li>
            </ul>

            <!-- moved progress + log here -->
            <div class="progressWrap">
                <div class="pRow">
                    <div class="pTitle">Overall progress</div>
                    <div id="overallMeta" class="pMeta">0 / 0 sheets</div>
                </div>
                <div class="bar">
                    <div id="overallFill" class="fill"></div>
                </div>

                <div class="pRow">
                    <div class="pTitle">Current file</div>
                    <div id="fileMeta" class="pMeta">‚Äì</div>
                </div>
                <div class="bar">
                    <div id="fileFill" class="fill alt"></div>
                </div>
            </div>

            <div id="log" class="log">Loading‚Ä¶</div>
        </aside>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const $ = (id) => document.getElementById(id);

            const dropzone = $("dropzone");
            const filePicker = $("filePicker");
            const fileListEl = $("fileList");
            const mergeBtn = $("mergeBtn");
            const resetBtn = $("resetBtn");
            const prefixNamesEl = $("prefixNames");
            const keepFormulasEl = $("keepFormulas");
            const outputNameEl = $("outputName"); // NEW
            const logEl = $("log");

            const overallFill = $("overallFill");
            const overallMeta = $("overallMeta");
            const fileFill = $("fileFill");
            const fileMeta = $("fileMeta");

            let selectedFiles = [];
            let dragFromIndex = null;

            const setLog = (t) => { logEl.textContent = t; };
            const addLog = (line) => { logEl.textContent += "\n" + line; logEl.scrollTop = logEl.scrollHeight; };

            setLog("App loaded ‚úÖ");

            function fmtBytes(bytes) {
                const units = ["B", "KB", "MB", "GB"];
                let b = bytes, i = 0;
                while (b >= 1024 && i < units.length - 1) { b /= 1024; i++; }
                return `${b.toFixed(i === 0 ? 0 : 1)} ${units[i]}`;
            }

            function fileKey(f) { return `${f.name}__${f.size}__${f.lastModified}`; }

            function sanitizeSheetName(name) {
                return name.replace(/[\[\]\*\?\/\\:]/g, " ").replace(/\s+/g, " ").trim().slice(0, 31);
            }

            function uniqueSheetName(wb, desired) {
                let name = sanitizeSheetName(desired) || "Sheet";
                const existing = new Set(wb.SheetNames);
                if (!existing.has(name)) return name;

                for (let i = 1; i < 999; i++) {
                    const suffix = ` (${i})`;
                    const base = name.slice(0, 31 - suffix.length);
                    const candidate = base + suffix;
                    if (!existing.has(candidate)) return candidate;
                }
                return ("Sheet " + Math.random().toString(16).slice(2, 6)).slice(0, 31);
            }

            function cloneWorksheet(ws) {
                const out = {};
                for (const k of Object.keys(ws)) {
                    const v = ws[k];
                    if (v && typeof v === "object") {
                        out[k] = Array.isArray(v)
                            ? v.map(x => (x && typeof x === "object" ? { ...x } : x))
                            : { ...v };
                    } else out[k] = v;
                }
                return out;
            }

            function setOverallProgress(done, total) {
                const pct = total ? Math.round((done / total) * 100) : 0;
                overallFill.style.width = pct + "%";
                overallMeta.textContent = `${done} / ${total} sheets`;
            }

            function setFileProgress(fileName, done, total) {
                const pct = total ? Math.round((done / total) * 100) : 0;
                fileFill.style.width = pct + "%";
                fileMeta.textContent = fileName ? `${fileName} ¬∑ ${done} / ${total}` : "‚Äì";
            }

            function renderFileList() {
                fileListEl.innerHTML = "";

                if (selectedFiles.length === 0) {
                    const li = document.createElement("li");
                    li.className = "fileitem";
                    li.innerHTML = `
              <div class="left">
                <div class="handle">‚ãÆ‚ãÆ</div>
                <div class="filemeta">
                  <div class="filename">No files added yet</div>
                  <div class="filesub"></div>
                </div>
              </div>`;
                    fileListEl.appendChild(li);
                    return;
                }

                selectedFiles.forEach((f, idx) => {
                    const li = document.createElement("li");
                    li.className = "fileitem";
                    li.draggable = true;
                    li.dataset.index = String(idx);

                    li.innerHTML = `
              <div class="left">
                <div class="handle" title="Drag to reorder">‚ãÆ‚ãÆ</div>
                <div class="filemeta">
                  <div class="filename" title="${f.name}">${f.name}</div>
                  <div class="filesub">${fmtBytes(f.size)} ¬∑ modified ${new Date(f.lastModified).toLocaleString()}</div>
                </div>
              </div>
              <div>
                <button class="btn small danger" type="button" data-remove="${idx}">Remove</button>
              </div>`;

                    li.addEventListener("dragstart", (e) => {
                        dragFromIndex = idx;
                        li.classList.add("dragging");
                        e.dataTransfer.effectAllowed = "move";
                        e.dataTransfer.setData("text/plain", String(idx));
                    });

                    li.addEventListener("dragend", () => {
                        li.classList.remove("dragging");
                        dragFromIndex = null;
                    });

                    li.addEventListener("dragover", (e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = "move";
                    });

                    li.addEventListener("drop", (e) => {
                        e.preventDefault();
                        const from = dragFromIndex ?? Number(e.dataTransfer.getData("text/plain"));
                        const to = idx;
                        if (Number.isNaN(from) || from === to) return;

                        const moved = selectedFiles.splice(from, 1)[0];
                        selectedFiles.splice(to, 0, moved);
                        updateUI();
                    });

                    fileListEl.appendChild(li);
                });

                fileListEl.querySelectorAll("[data-remove]").forEach(btn => {
                    btn.addEventListener("click", () => {
                        const idx = Number(btn.getAttribute("data-remove"));
                        selectedFiles.splice(idx, 1);
                        updateUI();
                    });
                });
            }

            function updateUI() {
                renderFileList();
                mergeBtn.disabled = selectedFiles.length === 0;
                setOverallProgress(0, 0);
                setFileProgress("", 0, 0);
            }

            function addFiles(files) {
                const incoming = Array.from(files || []);
                if (!incoming.length) return;

                const existingKeys = new Set(selectedFiles.map(fileKey));
                let added = 0, skipped = 0;

                for (const f of incoming) {
                    const isExcel = /\.(xlsx|xlsm)$/i.test(f.name);
                    if (!isExcel) { skipped++; continue; }

                    const key = fileKey(f);
                    if (existingKeys.has(key)) { skipped++; continue; }

                    selectedFiles.push(f);
                    existingKeys.add(key);
                    added++;
                }

                addLog(`‚úÖ Added: ${added} file(s)`);
                if (skipped) addLog(`‚ÑπÔ∏è Skipped: ${skipped} (duplicates or not Excel)`);
                updateUI();
            }

            // === DRAG & DROP FIX (Edge) ===
            const prevent = (e) => { e.preventDefault(); e.stopPropagation(); };

            ["dragenter", "dragover", "dragleave", "drop"].forEach(evt => {
                document.addEventListener(evt, prevent, { capture: true, passive: false });
            });

            ["dragenter", "dragover"].forEach(evt => {
                dropzone.addEventListener(evt, () => dropzone.classList.add("dragover"), { passive: true });
            });
            ["dragleave", "drop"].forEach(evt => {
                dropzone.addEventListener(evt, () => dropzone.classList.remove("dragover"), { passive: true });
            });

            dropzone.addEventListener("drop", (e) => {
                const dt = e.dataTransfer;
                addLog("üì• Drop detected (zone)");
                if (!dt) return;
                addFiles(dt.files);
            }, { passive: false });

            window.addEventListener("drop", (e) => {
                const dt = e.dataTransfer;
                addLog("üì• Drop detected (window)");
                if (!dt) return;
                addFiles(dt.files);
            }, { capture: true, passive: false });

            // File picker
            filePicker.addEventListener("change", () => {
                addLog("üìÇ Picker change detected");
                addFiles(filePicker.files);
                filePicker.value = "";
            });

            async function buildCache(files) {
                const cache = [];
                let totalSheets = 0;

                for (const f of files) {
                    addLog(`üì¶ Loading: ${f.name}`);
                    const buf = await f.arrayBuffer();
                    const wb = XLSX.read(buf, {
                        type: "array",
                        cellFormula: keepFormulasEl.checked,
                        cellNF: true,
                        cellText: false
                    });
                    totalSheets += wb.SheetNames.length;
                    cache.push({ file: f, wb });
                }
                return { cache, totalSheets };
            }

            async function mergeExcels(files) {
                if (typeof XLSX === "undefined") {
                    addLog("‚ùå Cannot merge: XLSX library not available (cdn blocked).");
                    return;
                }

                mergeBtn.disabled = true;
                resetBtn.disabled = true;
                filePicker.disabled = true;
                if (outputNameEl) outputNameEl.disabled = true; // NEW

                try {
                    addLog("\n‚ñ∂ Starting merge‚Ä¶");
                    const { cache, totalSheets } = await buildCache(files);

                    setOverallProgress(0, totalSheets);
                    let doneSheets = 0;

                    const outWb = XLSX.utils.book_new();

                    for (const entry of cache) {
                        const f = entry.file;
                        const wb = entry.wb;

                        const fileStem = f.name.replace(/\.[^.]+$/, "");
                        const prefix = prefixNamesEl.checked ? fileStem : "";

                        setFileProgress(f.name, 0, wb.SheetNames.length);
                        addLog(`\nüìÑ Merging: ${f.name}`);

                        let fileDone = 0;
                        for (const sheetName of wb.SheetNames) {
                            const ws = wb.Sheets[sheetName];
                            const desired = prefix ? `${prefix} - ${sheetName}` : sheetName;
                            const finalName = uniqueSheetName(outWb, desired);

                            XLSX.utils.book_append_sheet(outWb, cloneWorksheet(ws), finalName);

                            fileDone++; doneSheets++;
                            setFileProgress(f.name, fileDone, wb.SheetNames.length);
                            setOverallProgress(doneSheets, totalSheets);

                            await new Promise(r => requestAnimationFrame(r));
                        }
                    }

                    addLog("\nüì¶ Building output‚Ä¶");
                    const outArray = XLSX.write(outWb, { bookType: "xlsx", type: "array" });
                    const blob = new Blob([outArray], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });

                    // NEW: output filename from input (sanitized)
                    const rawName = (outputNameEl?.value || "").trim();
                    const safeName = rawName
                        .replace(/[<>:"/\\|?*\x00-\x1F]/g, " ")
                        .replace(/\s+/g, " ")
                        .trim();

                    const fallbackName = `Merged_${new Date().toISOString().slice(0, 10)}.xlsx`;
                    const finalName = safeName
                        ? (safeName.toLowerCase().endsWith(".xlsx") ? safeName : `${safeName}.xlsx`)
                        : fallbackName;

                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = finalName; // NEW
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);

                    addLog(`\nüéâ Done! Download started: ${finalName}`);
                } catch (e) {
                    addLog(`\n‚ùå Error: ${e?.message || e}`);
                } finally {
                    resetBtn.disabled = false;
                    filePicker.disabled = false;
                    if (outputNameEl) outputNameEl.disabled = false; // NEW
                    mergeBtn.disabled = selectedFiles.length === 0;
                }
            }

            mergeBtn.addEventListener("click", async () => {
                if (!selectedFiles.length) return;
                await mergeExcels(selectedFiles);
            });

            resetBtn.addEventListener("click", () => {
                selectedFiles = [];
                updateUI();
                setLog("App loaded ‚úÖ");
                if (outputNameEl) outputNameEl.value = ""; // NEW (optional)
            });

            updateUI();
        });
    </script>
</body>

</html>